
<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="icon" type="image/png" href="/img/robot.png">
  <link rel="stylesheet" href="/css/style.css">
  <title>
    小沙丘的网络漫游记
  </title>
<link rel="stylesheet" href="/css/prism-ghcolors.css" type="text/css"></head>
<body>
  <script>
    if (/mobile/i.test(navigator.userAgent) || /android/i.test(navigator.userAgent)){
      document.body.classList.add('mobile');            
    } else{
      document.body.classList.add('pc');
			document.getElementsByTagName("html")[0].style.fontSize="62.5%";
    }
  </script>
  <div class="container">
<!-- 用于文章页面的顶部，提供返回主页和主题页的按键 -->
<!-- 头部开始 -->

<div id="header">
    <p>小沙丘的网络漫游记
      <span> » 
        <a href="/home/">首页</a>
      </span>
      
      <span> » 
          <a href="/tags/PXT/">
            PXT
          </a>
      </span>
      
    </p>
</div>

<!-- 头部结束 -->



<!-- 分类组件，放置于文章页面的顶部，提供上(或下)一篇导航按键。 -->
<div class="asset-nav">
    <div class="entry-categories">
      <p>分类：
        <span> 
            <a href="/tags/PXT/">
              PXT
            </a>
        </span>
      </p>
    </div>
    <div class="entry-location-mobile">
        <span>
            
            <a href="/2017/10/11/pxt-package-pxtjson/">
              ⇐ 
            </a>
        </span>
        <span>
            
            <a href="/2017/10/12/yi-9-xiaoxu/">
              ⇒
            </a>
        </span>
    </div>
    <div class="entry-location">
        <P>上一篇：
                <a href="/2017/10/11/pxt-package-pxtjson/">
                    配置package | PXT
                </a>
        </P>
        <P>下一篇：

                <a href="/2017/10/12/yi-9-xiaoxu/">
                    小畜卦 | 易经
                </a>
        </P>
    </div>
</div>

<div class="post">
<h1>扩展package | PXT</h1>
<div class="post-meta">
  <p>作者： Lian</p>
  <p>日期：
    2017年10月11日 21:10
  </p>
</div>
      

<div class="page">
    <h1 id="Extensions"><a href="#Extensions" class="headerlink" title="Extensions"></a>Extensions</h1><p>A package may have an associated editor extension hosted in the Github Pages section of the repo.</p>
<ul>
<li><a href="https://github.com/Microsoft/pxt-neoanim" target="_blank" rel="external">pxt-neoanim</a> is an example of specialized NeoPixel animation editor.</li>
</ul>
<h2 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h2><p>The extension is configured in the <a href="/packages/pxtJson">pxt.json</a> file by adding an <code>extension</code> field:</p>
<pre class=" language-typescript-ignore"><code class="language-typescript-ignore">{
    ...
    extension: {}
}
</code></pre>
<p>The editor will automatically add an “Editor” button for the extension in the package category.</p>
<h2 id="Protocol"><a href="#Protocol" class="headerlink" title="Protocol"></a>Protocol</h2><p>The editor and the extension IFrame communicate via a protocol of IFrame messages.</p>
<ul>
<li>messages have a unique <code>id</code> used to correlate response to requests.</li>
<li>a <code>response</code> message can be requested. The <code>id</code> identifer can be used to correlate a receive response to the original query.</li>
<li>all message sent by the extension must contain the extension id, <code>extId</code>. This identifier is passed when loading the IFrame (see <strong>Initialization</strong>)</li>
</ul>
<pre class=" language-typescript-ignore"><code class="language-typescript-ignore">// sending message
var msg = {
    id: Math.random().toString(),
    type: "pxtpkgext",
    action: "extinit",
    extId: extId,
    response: true
}
window.parent.postMessage(msg, "*");

// handle the response
function receivedResponse(resp) {
  if (resp.action === "extinit")
    console.log('initialized!')
}
window.addEventListener("message", function(ev) {
  var resp = ev.data;
  if (resp && resp.type === "pxtpkgext")
    receivedResponse(resp);
}, false);
</code></pre>
<h3 id="Initialization"><a href="#Initialization" class="headerlink" title="Initialization"></a>Initialization</h3><p>When the user presses the extension button,</p>
<ul>
<li>The GitHub pages site is loaded in an IFrame with an extension id in the hashmark, e.g. <a href="https://microsoft.github.io/pxt-neoanim/#extid" target="_blank" rel="external">https://microsoft.github.io/pxt-neoanim/#extid</a> for the package <a href="https://github.com/Microsoft/pxt-neoanim" target="_blank" rel="external">https://github.com/Microsoft/pxt-neoanim</a>.</li>
</ul>
<h3 id="hint"><a href="#hint" class="headerlink" title="~ hint"></a>~ hint</h3><p>Store the extension id as it needs to be used in every message.</p>
<pre class=" language-typescript-ignore"><code class="language-typescript-ignore">var extId = window.location.hash.substr(1);
</code></pre>
<h3 id=""><a href="#" class="headerlink" title="~"></a>~</h3><ul>
<li>Once fully loaded, the extension sends a <code>extinit</code> message to the parent window</li>
</ul>
<pre class=" language-typescript-ignore"><code class="language-typescript-ignore">var msg = {
    id: Math.random().toString(),
    type: "pxtpkgext",
    action: "extinit",
    extId: extId
}
...
</code></pre>
<h3 id="Read-and-write-code"><a href="#Read-and-write-code" class="headerlink" title="Read and write code"></a>Read and write code</h3><p>The extension can read (<code>extreadcode</code>) and write (<code>extwritecode</code>) a dedicated TypeScript and JSON file in the project. The JSON file is designed to store rich metadata while the TypeScript is the “code behind” that gets executed. This feature does not require permissions.</p>
<ul>
<li>write code</li>
</ul>
<pre class=" language-typescript-ignore"><code class="language-typescript-ignore">var msg = {
    id: Math.random().toString(),
    type: "pxtpkgext",
    action: "extwritecode",
    extId: extId,
    body: {
        code: "// generated TypeScript code",
        json: "serialized JSON here"
    }
}
...
</code></pre>
<ul>
<li>read code</li>
</ul>
<pre class=" language-typescript-ignore"><code class="language-typescript-ignore">var id = Math.random().toString();
var msg = {
    id: id,
    type: "pxtpkgext",
    action: "extreadcode",
    extId: extId,
    response: true
}
...

function receivedResponse(resp) {
  if (resp.action === "extreadcode" && resp.id === id && resp.body) {
      var ts = resp.body.code;
      var json = JSON.parse(resp.body.json);
      ...
  }
}
...
</code></pre>
<h3 id="Read-and-write-user-code"><a href="#Read-and-write-user-code" class="headerlink" title="Read and write user code"></a>Read and write user code</h3><p>The <code>extusercode</code> message requests to read the entire set of files in the project. The user will be prompted to give permission. If successfull, the response contains a <code>resp</code> field with a map of the file names to file contents.</p>
<pre class=" language-typescript-ignore"><code class="language-typescript-ignore">export interface UserCodeResponse extends ExtensionResponse {
    /* A mapping of file names to their contents */
    resp?: { [index: string]: string };
}
</code></pre>
<h3 id="Data-streams"><a href="#Data-streams" class="headerlink" title="Data streams"></a>Data streams</h3><p>When available, the editor may stream data coming from the devices. The <code>extdatastream</code> message requests to stream data. The user will be prompted to give permission. The following message requests for serial messages:</p>
<pre class=" language-typescript-ignore"><code class="language-typescript-ignore">var msg {
    ...
    action: "extdatastream",
    body: {
        serial: true
    }
}
...
</code></pre>
<p>If successful, the editor will proxy serial messages to the editor IFrame.</p>

</div>
</div>

<!-- 文档信息 -->
<div class="post-foot">
  <h3>文档信息</h3>
  <ul>
    <li>版权声明：自由转载-非商用-非衍生-保持署名（
      <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>）
    </li>
    <li>作者：Lian</li>
    <li>日期：2017年10月11日 21:10</li>
  </ul>
</div>
      


<div class="content-comment">
  <h2>留言</h2>
  
  
<div id="" class="item-comment">
  <p class="author">
    
    lian <span>说：</span>
  </p>

  <div class="content">
      <blockquote>
        <pre>引用xiaotian044500的发言：</pre>
        看来这么想的不在少数啊, 确实挺像的.
        </blockquote>
        哈哈
  </div>
    
</div>
		
</div>

<!-- 评论输入组件，填写数据：留言，称呼，电子邮件 -->

<div class="form-comment">
  <h2>
		我要发表看法
	</h2>


	<form method="post" action="" 
	 onsubmit="return pleaseWait()">
	 <!-- 留言正文 -->
	 
		
<p>
	<label for="comment-content">
		您的留言:
	</label>
</p>

<p>
	<textarea 
	id="comment-content" 
	name="content" 
	rows="10" cols="50">
	</textarea>
</p>

		<!-- 姓名 -->
	 
		
<p>
	<label for="comment-author">
		您的大名:
	</label>
</p>

<p>
	<input 
	id="comment-author" 
	name="author" 
	size="30" 
	value=""
	pattern="^.*+$"
	required
	>
	<span class="hint">
			 «-必填
	</span
</p>


		<!-- 微信 -->
	 
		
<p>
	<label for="comment-wechat">
		您的微信:
	</label>
</p>

<p>
	<input 
	id="comment-wechat" 
	name="wechat" 
	size="30" 
	value=""
	pattern="^[a-zA-Zd_]{5,}$"
	
	>
	<span class="hint">
			 «-选填，不公开
	</span
</p>


		<!-- 电子邮箱 -->
		
		
<p>
	<label for="comment-email">
		电子邮箱：
	</label>
</p>

<p>
	<input 
	id="comment-email" 
	name="email" 
	size="30" 
	value=""
	pattern="^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(.[a-zA-Z0-9_-]+)+$"
	
	>
	<span class="hint">
			 «-选填，不公开
	</span
</p>


		<p>
			<input type="submit" class="submit-button" value="发表">
			<span class="hint"> «- 点击按钮</span>
		</p>
	</form>

</div>


<!-- data:{
	name:'',
	type:'passwor',
	label:'您的大名',
	hint:'',
	pattern:'[A-z]{3}',
	required:"required"
} -->

<div class="footer">
  Copyright @ <a href="/">lian</a> | 2009-2018
</div>
</div>
</body>

</html>

