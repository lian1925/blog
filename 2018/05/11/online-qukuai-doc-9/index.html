
<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="icon" type="image/png" href="/img/sand2.png">
  <link rel="shortcut icon" type="image/x-icon" href="/img/sand2.png">
  <meta property="og:image" content="https://assets-cdn.github.com/images/modules/open_graph/github-octocat.png">
  
  <link rel="stylesheet" href="/css/style.css?v=1.3"> 
  <link href="//vjs.zencdn.net/6.7/video-js.min.css" rel="stylesheet">
  <script src="//vjs.zencdn.net/6.7/video.min.js"></script>
  
  <title>小故事 9 | Bob and Alice | 小沙丘的网络漫游记</title>
 
<link rel="stylesheet" href="/css/prism-ghcolors.css" type="text/css"></head>
<body>
  
  <script>
      if (/mobile/i.test(navigator.userAgent) || /android/i.test(navigator.userAgent)){
        document.body.classList.add('mobile');            
      } else{
        document.body.classList.add('pc');
        document.getElementsByTagName("html")[0].style.fontSize="62.5%";
      }
      var u = navigator.userAgent;
var isAndroid = u.indexOf('Android') > -1 || u.indexOf('Adr') > -1; //android终端
var isiOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端
if(isiOS){
  document.body.classList.add('ios');
  document.getElementsByTagName("html")[0].style.fontSize="65%";
           
}
    </script>

  <div class="container">
<!-- 用于文章页面的顶部，提供返回主页和主题页的按键 -->
<!-- 头部开始 -->

<div id="header">
    <p>小沙丘的网络漫游记
      <span> » 
        <a href="/home/">首页</a>
      </span>
      
      <span> » 
          <a href="/tags/区块链/">
            区块链
          </a>
      </span>
      
    </p>
</div>

<!-- 头部结束 -->



<!-- 分类组件，放置于文章页面的顶部，提供上(或下)一篇导航按键。 -->
<div class="asset-nav">
    <div class="entry-categories">
      <p>主题：
        <span> 
            <a href="/tags/区块链/">
              区块链
            </a>
        </span>
      </p>
    </div>
    <div class="entry-location-mobile">
        <span>
            
            <a href="/2018/05/11/online-qukuai-doc-8/">
            &#8676;
            </a>
        </span>
        <span>
            
            <a href="/2018/05/13/online-qukuai-doc-10/">
              &#8677;
            </a>
        </span>
    </div>
    <div class="entry-location">
        <P>上一篇：
                <a href="/2018/05/11/online-qukuai-doc-8/">
                    比特币 8
                </a>
        </P>
        <P>下一篇：

                <a href="/2018/05/13/online-qukuai-doc-10/">
                    比特币钱包地址、私钥和公钥 10
                </a>
        </P>
    </div>
</div>

<div class="post">
<div class="title-post">
<h1>小故事 9 | Bob and Alice</h1>
<div class="post-meta">
  <p>作者： Lian</p>
  <p>日期：
    2018年05月11日 16:05
  </p>
</div>
</div>



  
  <div class="page">
      <h2 id="1-托管和仲裁"><a href="#1-托管和仲裁" class="headerlink" title="1 托管和仲裁"></a>1 托管和仲裁</h2><h3 id="1-不信任"><a href="#1-不信任" class="headerlink" title="1 不信任"></a>1 不信任</h3><p>Charlie客户想从Bob商人购买一种产品，但他们都不信任对方，所以他们使用合同帮助确保Charlie获得商品，Bob获得付款。</p>
<h3 id="2-合同"><a href="#2-合同" class="headerlink" title="2 合同"></a>2 合同</h3><p>一个简单的合同可以说Charlie会把satoshis花费到某个输出，只有Charlie和Bob都签名了这个输入才能花费它。这意味着鲍勃不会得到报酬，除非查理得到他的商品，但查理无法获得商品和保留他的付款。</p>
<h3 id="3-仲裁"><a href="#3-仲裁" class="headerlink" title="3 仲裁"></a>3 仲裁</h3><p>如果有争议，这个简单的合约没有什么帮助，所以Bob和Charlie征求了Alice仲裁员的帮助来创建一个托管合约。</p>
<p>Charlie花费这些satoshis到一个输出，这个输出只有三人中的两人都签名输入的话才能被花费。</p>
<p>现在如果一切正常Charlie可以支付给Bob，如果有问题的话Bob可以退款，或者如果有争议的话爱丽丝可以仲裁并决定谁应该得到satoshis。</p>
<h3 id="4-协议"><a href="#4-协议" class="headerlink" title="4 协议"></a>4 协议</h3><p>要创建一个多重签名（multisig）输出，他们每个给他人一个公钥。然后，Bob创建以下P2SH multisig redeem脚本：</p>
<pre class=" language-js"><code class="language-js">OP_2 <span class="token punctuation">[</span>A<span class="token string">'s pubkey] [B'</span>s pubkey<span class="token punctuation">]</span> <span class="token punctuation">[</span>C's pubkey<span class="token punctuation">]</span> OP_3 OP_CHECKMULTISIG
</code></pre>
<p>（将公钥压入堆栈的Opcodes未显示。）</p>
<p>OP_2和OP_3将实际数字2和3压入堆栈上。OP_2指定需要2个签名，OP_3指定需要提供3个未哈希过的公钥。这是一个2-of-3 multisig pubkey脚本，更一般地称为m-of-n pubkey脚本（m是需要的最小匹配的签名，n是提供公钥的数量）。</p>
<h3 id="5-经过"><a href="#5-经过" class="headerlink" title="5 经过"></a>5 经过</h3><p>Bob向Charlie发送redeem脚本，Charlie检查确定他的公钥和Alice的公钥。然后，他将redeem 脚本求哈希，来创建P2SH redeem脚本，并向其支付satoshis。Bob看到付款被添加到块链并运送商品。</p>
<h3 id="6-途中受损"><a href="#6-途中受损" class="headerlink" title="6 途中受损"></a>6 途中受损</h3><p>不幸的是，商品在运输途中受到轻微破坏。Charlie想要一个完整的退款，但Bob认为10％退款是足够的。他们转向Alice来解决这个问题。Alice要求Charlie的照片证据，以及Bob创建查理检查过的redeem脚本的副本。</p>
<p>在查看证据后，Alice认为40％的退款是足够的，所以她创建并签署两个输出的交易，一个花费satoshis到Bob的公开密钥，剩下的40％花到Charlie的公钥。</p>
<h3 id="7-仲裁协议"><a href="#7-仲裁协议" class="headerlink" title="7 仲裁协议"></a>7 仲裁协议</h3><p>在签名脚本中，Alice把她的签名和Bob创建的未哈希序列化的兑换redeem的副本放入其中。她向Bob和Charlie提供了不完整交易的副本。他们中的任何一个可以通过添加他的签名来完成它，以创建以下签名脚本：</p>
<pre class=" language-js"><code class="language-js">OP_0 <span class="token punctuation">[</span>A<span class="token string">'s signature] [B'</span>s or C's signature<span class="token punctuation">]</span> <span class="token punctuation">[</span>serialized redeem script<span class="token punctuation">]</span>
</code></pre>
<p>（将签名和redeem脚本压入堆栈的Opcodes未显示。OP_0是原始实现中一个错误的解决方法，必须保留兼容性。请注意，签名脚本必须以与redeem脚本中出现的相应的公钥相同的顺序提供签名 。有关详细信息，请参见OP_CHECKMULTISIG中的说明。）</p>
<p>当交易被广播到网络时，每个节点根据Charlie先前支付的P2SH输出检查签名脚本，确保redeem脚本和之前提供的redeem脚本哈希值相匹配。然后评估将两个签名用作输入数据的兑换脚本。假设兑换脚本验证成功，两个交易输出显示在Bob和Charlie的钱包中作为可支付余额。</p>
<h3 id="8-结局"><a href="#8-结局" class="headerlink" title="8 结局"></a>8 结局</h3><p>然而，如果Alice创建并签名了一个交易，他们都不会同意，例如将所有的satoshis支付给她自己，Bob和Charlie可以找到一个新的仲裁员，并签署一个支付satoshis的交易到另一个2-of-3 mutlisig redeem脚本哈希, 这个包括一个新的仲裁员的公钥。这意味着鲍勃和查理从来不需要担心他们的仲裁员偷他们的钱。</p>
<h2 id="2-交易"><a href="#2-交易" class="headerlink" title="2 交易"></a>2 交易</h2><p>Alice花费satoshis到一个典型的比特币地址，然后让Bob稍后用简单密钥对使用这些satoshis。</p>
<h3 id="1-准备密钥对"><a href="#1-准备密钥对" class="headerlink" title="1 准备密钥对"></a>1 准备密钥对</h3><p>在Alice创建第一个交易之前，Bob必须先生成一个私有/公开的密钥对。比特币使用secp256k1的椭圆曲线数字签名算法(ECDSA)；secp256k1私钥是256位随机数据。该数据的副本被确定地转换为secp256k1 公钥。因为以后可以可靠地进行转换，所以不需要存储公钥。</p>
<p>然后公钥（pubkey）经过密码哈希运算。此pubkey哈希运算也可以在以后可靠地重复，因此也不需要存储。哈希运算缩短并混淆了公钥，使人工转录更容易，并提供安全性，防止从公钥重建私钥这样的意外问题。</p>
<h3 id="2-发送公钥"><a href="#2-发送公钥" class="headerlink" title="2 发送公钥"></a>2 发送公钥</h3><p>Bob向Alice提供了pubkey哈希值。Pubkey哈希值几乎总是被编码为Bitcoin 地址，它们是包含地址版本号，哈希值，来捕获打字错误的checksum错误检测校验base58编码字符串。地址可以通过任何介质传输，包括防止与之通信的接收者花销的单向介质，并可以进一步编码为另外一种格式，例如包含比特币URI的OR码。</p>
<h3 id="3-创建交易"><a href="#3-创建交易" class="headerlink" title="3 创建交易"></a>3 创建交易</h3><p>一旦Alice拥有地址并将其解码为标准哈希值，就可以创建第一个交易。她创建了一个包含指令的标准的P2PKH交易输出，这个指令允许任何人花费这个输出,若他们能证明他们控制着相应于Bob哈希过的公钥的私钥。这些指令称为pubkey脚本或scriptPubKey。</p>
<p>爱丽丝广播该交易，并将其添加到区块链。网络将它归类为未花费的交易输出UTXO，Bob的钱包软件也将其显示为可花费的数额。</p>
<h3 id="4-花费"><a href="#4-花费" class="headerlink" title="4 花费"></a>4 花费</h3><p>一段时间后，Bob决定花费UTXO，他必须创建一个输入，该输入引用Alice创建的有交易标识符txid的交易和有输出索引的特定输出。然后他必须创建一个签名脚本 - 满足Alice在之前输出pubkey脚本里列出的条件的一组数据参数。签名脚本也称为scriptSigs。</p>
<p>Bob签名的数据包括之前交易的txid，之前输出的pubkey脚本，Bob创建让下一个接收者花费交易输出的pubkey脚本，satoshis的金额。实质上，除了保存完整的公钥和secp256k1签名的任何签名脚本之外，整个交易都被签名。</p>
<p>在Bob把他的签名和公钥放到签名脚本之后，Bob通过P2P网络将该交易广播给Bitcoin矿工。每个节点和矿工在进一步广播或试图将其加入一个包含交易的新块之前独立地验证交易。</p>
<h2 id="3-微支付渠道"><a href="#3-微支付渠道" class="headerlink" title="3 微支付渠道"></a>3 微支付渠道</h2><h3 id="1-工作"><a href="#1-工作" class="headerlink" title="1 工作"></a>1 工作</h3><p>Alice还为Bob兼职审核论坛帖子。每当有人发帖到Bob的论坛，Alice都要浏览它，确保它不会令人反感或垃圾帖子。</p>
<h3 id="2-报酬"><a href="#2-报酬" class="headerlink" title="2 报酬"></a>2 报酬</h3><p>但Bob经常忘记付钱给她，所以Alice要求在她批准或拒绝的每个帖子后立即支付。鲍勃说他不能这么做，因为数百笔小额付款会在交易费用中花费成千上万的satoshis，所以Alice建议使用微支付渠道。</p>
<h3 id="3-债券"><a href="#3-债券" class="headerlink" title="3 债券"></a>3 债券</h3><p>Bob向Alice询问她的公钥，然后创建两个交易。第一笔交易支付100 millibitcoins到一个P2SH输出，它的2-of-2 multisig redeem 脚本需要Alice和Bob都签名。这就是债券交易。广播此交易将让Alice持有millibitcoins质押币，所以Bob现在将交易私有，并创建第二个交易。</p>
<h3 id="4-花费-1"><a href="#4-花费-1" class="headerlink" title="4 花费"></a>4 花费</h3><p>第二个交易花费所有第一个交易的millibitcoins（减去交易费）在由locktime强制执行的24小时延时后返回给Bob。这是退款交易。Bob不能自己签名退款交易，所以他把它交给Alice签字，如下图所示。</p>
<p>Alice检查退款交易的locktime是未来24小时，签名，并将其副本返回给Bob。然后，她询问Bob进行债券交易，并检查退款交易是否支付债券交易的输出。她现在可以将债券交易广播到网络，以确保鲍勃必须等待时间锁定到期，然后再进一步消费他的millibitcoins。Bob迄今为止还没有花费任何东西，除了可能还有一个小的交易费，他将能够在24小时内广播一个完整的退款的退款交易。</p>
<p>现在，当Alice做值1 millibitcoin的工作时，她要求Bob创建并签署新版本的退款交易。交易的第二版将1 millibitcoin花费到Alice，另一个99返回给Bob；它没有锁定时间，所以Alice只要她想要就可以签署并花费它。（但她不会立即这样做）</p>
<p>Alice和Bob重复这些工作和付款步骤，直到Alice完成一天的工作，或者直到时间锁定即将到期。Alice签署了退款交易的最终版本，并将其广播，支付给自己，并将余下的余额退还给Bob。第二天，当Alice开始工作时，他们创建一个新的微支付渠道。</p>
<p>如果Alice在时间锁定到期之前未能广播退款事务的新版本，则Bob可以广播第一个版本并收到一个完整的退款。这是微支付渠道最适合小额付款的一个原因 - 如果Alice的互联网服务在时间锁定到期时间断了几个小时，她可能会被骗走付款。</p>
<p>交易可扩展性，在上面交易部分讨论过，是限制微支付渠道的价值的另一个原因。如果有人使用交易可扩展性来破坏两个交易之间的链接，即使没有完成任何工作，Alice也可以保留Bob的100 millibitcoins质押币。</p>
<p>对于较大的付款，比特币交易费用占交易总额的百分比非常低，因此使用立即广播的单独交易来保护付款更有意义。</p>
<h2 id="4-隐私"><a href="#4-隐私" class="headerlink" title="4 隐私"></a>4 隐私</h2><h3 id="1-担忧"><a href="#1-担忧" class="headerlink" title="1 担忧"></a>1 担忧</h3><p>Alice很担心她的隐私。她知道每个交易都被添加到公共块链中，所以当Bob和Charlie付钱时，他们可以轻松跟踪satoshis来了解她支付过的Bitcoin 地址，支付多少钱，还有她还剩多少satoshis。</p>
<h3 id="2-匿名"><a href="#2-匿名" class="headerlink" title="2 匿名"></a>2 匿名</h3><p>Alice不是一个犯罪分子，她只是希望对获知她花费及她剩余的satoshis合理地拒绝，所以她在她的电脑上启动了Tor匿名服务，并以”AnnoGirl”登陆到IRC聊天室。</p>
<h3 id="3-联合"><a href="#3-联合" class="headerlink" title="3 联合"></a>3 联合</h3><p>同样“Nemo”和“Neminem”也在聊天室，他们共同地同意将satoshis彼此转移，除了他们之外，没有人可以肯定谁控制这些satoshis。但是他们面临两难的境地：谁先将他们的satoshis转移到另外两个假名的人之一？CoinJoin风格的合约如下图所示，使得这个决定变得容易：他们创造了一个单一的交易，同时进行所有的支出，确保没有人能够窃取他人的satoyis。</p>
<p>每个参与者都可以查看他们可以花费的100 millibitcoins的UTXOs的集合信息。然后，他们每个都会生成一个全新的公钥，并向协调人提供UTXO细节和pubkey哈希。在这种情况下，协调者是AnonGirl；她将每个UTXO的交易创建到三个相等大小的输出。一个输出转到每个参与者pubkey哈希。</p>
<p>AnonGirl然后使用SIGHASH_ALL签名输入，以确保没有人可以更改输入或输出详细信息。她向Nemo提供部分签名的交易，他们以相同的方式签署他的输入，并将其传递给同样的方式签署的Neminem。Neminem然后将交易广播到P2P网络，将所有millibitcoins混合在一个交易中。</p>
<p>如图所示，除了AnonGirl，Nemo和Neminem之外，任何人都无法肯定谁收到哪个输出，所以他们可以不可追踪地花费他们的输出。</p>
<h3 id="3-无法跟踪"><a href="#3-无法跟踪" class="headerlink" title="3 无法跟踪"></a>3 无法跟踪</h3><p>现在当Bob或Charlie尝试通过块链跟踪Alice的交易时，他们还将看到Nemo和Neminem所做的交易。如果Alice做了更多的混币交易，Bob和Charlie可能不得不猜测几十个或几百个人中哪些实际上是由爱丽丝制造的交易。</p>
<p>Alice’s satoshis的完整历史仍然在块链中，所以一个确定的调查员可以和AnonGirl CoinJoined的人交谈，找出她的最终来源satoshis，可能会将AnonGirl显露为Alice。但是，对于随便查看区块链历史信息的人来说，爱丽丝获得了合理的可否认性。</p>
<h3 id="4-CoinJoin服务"><a href="#4-CoinJoin服务" class="headerlink" title="4 CoinJoin服务"></a>4 CoinJoin服务</h3><p>上文所述的CoinJoin技术使参与者花费少量satoshis来支付交易费。一种替代技术，购买者CoinJoin，实际上可以保存他们satoshis，同时提高他们的隐私。</p>
<p>AnonGirl等待IRC聊天室，直到她想要购买。她宣布她打算使用satoshis，等待有人想要从另一个商家进行购买。然后，它们以与之前相同的方式组合它们的输入，但将输出设置为单独的商户地址，所以没有人能够仅从块链历史单独指出其中一个人从商人那里买了什么。</p>
<p>由于他们不得不支付交易费来进行购买，因此AnonGirl和她的共同消费者不需要支付任何额外费用，但是由于它们通过组合多个交易减少开销，节省了字节数，他们可能能够支付较小的集合交易费，从而为他们致以节省少量的satoshis。</p>

  </div>
</div>


<p class="nav-foot">
  <span class="left"><a href="/2018/05/11/online-qukuai-doc-8/">« 比特币 8</a></span>
  <span class="right"><a href="/2018/05/13/online-qukuai-doc-10/">比特币钱包地址、私钥 »</a></span>
</p>

<!-- 文档信息 -->
<div class="post-foot">
  <h3>文档信息</h3>
  <ul>
    <li>版权声明：自由转载-非商用-非衍生-保持署名（
      <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>）
    </li>
    <li>作者：<a href="/">Lian</a></li>
    <li>日期：2018年05月11日 16:05</li>
    <li>邮箱：lian1925@126.com</li>
  </ul>
</div>
      




<div class="content-comment">
  <h2>留言</h2>
  
  
		
</div>

<!-- 评论输入组件，填写数据：留言，称呼，电子邮件 -->

<div class="form-comment">
  <h2>
		我要发表看法
	</h2>

	<form method="post" 
	target="targetIfr"
	action="">
	 <!-- 留言正文 -->
	 
		
<p>
	<label for="comment-content">
		您的留言:
	</label>
</p>

<p>
	<textarea 
	id="comment-content" 
	name="content" 
	rows="10" cols="50">
	</textarea>
</p>

		<!-- 姓名 -->
	 
		
<p>
	<label for="comment-author">
		您的大名:
	</label>
</p>

<p>
	<input 
	id="comment-author" 
	name="author" 
	size="30" 
	value=""
	pattern="^.{2,150}$"
	required
	>
	<span class="hint">
			 «-必填
	</span
</p>


		<!-- 微信 -->
	 
		
<p>
	<label for="comment-wechat">
		您的微信:
	</label>
</p>

<p>
	<input 
	id="comment-wechat" 
	name="wechat" 
	size="30" 
	value=""
	pattern="^[a-zA-Zd_]{5,}$"
	
	>
	<span class="hint">
			 «-选填，不公开
	</span
</p>


		<!-- 电子邮箱 -->
		
		
<p>
	<label for="comment-email">
		电子邮箱：
	</label>
</p>

<p>
	<input 
	id="comment-email" 
	name="email" 
	size="30" 
	value=""
	pattern="^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(.[a-zA-Z0-9_-]+)+$"
	
	>
	<span class="hint">
			 «-选填，不公开
	</span
</p>


		
		<p>

		
<div class="button">
    <input 
    class="submit-button" 
    onclick="doButton('addComment')"
    value="发表">
    <span class="hint"> «- 点击按钮</span>
</div>
		</p>
	</form>
	<iframe name="targetIfr" style="display:none"></iframe> 
</div>


<!-- data:{
	name:'',
	type:'passwor',
	label:'您的大名',
	hint:'',
	pattern:'[A-z]{3}',
	required:"required"
} -->


<p id="info-meta" style="display:none;">
  online-qukuai-doc-9
</p>


<p id="info-url" style="display:none;">
  
</p>

<div class="footer">
  Copyright @ <a href="/">lian</a> | 2009-2018
</div>

</div>

<script src="/js/jquery.js"></script>
<script src="/js/APlayer.min.js"></script>
<script src="/js/post.js"></script>

</body>

</html>

