
<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="icon" type="image/png" href="/img/sand2.png">
  <link rel="shortcut icon" type="image/x-icon" href="/img/sand2.png">
  <meta property="og:image" content="https://assets-cdn.github.com/images/modules/open_graph/github-octocat.png">
  
  <link rel="stylesheet" href="/css/style.css?v=1.3"> 
  <link href="//vjs.zencdn.net/6.7/video-js.min.css" rel="stylesheet">
  <script src="//vjs.zencdn.net/6.7/video.min.js"></script>
  
  <title>Static TypeScript | 小沙丘的网络漫游记</title>
 <meta name="description" content="" >

 <!-- 百度统计 -->
 <script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?eafa0040e1ab3bed28ce82ef03de6e01";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
  </script>
  
<link rel="stylesheet" href="/css/prism-ghcolors.css" type="text/css"></head>
<body>
  
  <script>
      if (/mobile/i.test(navigator.userAgent) || /android/i.test(navigator.userAgent)){
        document.body.classList.add('mobile');            
      } else{
        document.body.classList.add('pc');
        document.getElementsByTagName("html")[0].style.fontSize="62.5%";
      }
      var u = navigator.userAgent;
var isAndroid = u.indexOf('Android') > -1 || u.indexOf('Adr') > -1; //android终端
var isiOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端
if(isiOS){
  document.body.classList.add('ios');
  document.getElementsByTagName("html")[0].style.fontSize="65%";
           
}
    </script>

  <div class="container">
<!-- 用于文章页面的顶部，提供返回主页和主题页的按键 -->
<!-- 头部开始 -->

<div id="header">
    <p>小沙丘的网络漫游记
      <span> » 
        <a href="/home/">首页</a>
      </span>
      
      <span> » 
          <a href="/tags/PXT/">
            PXT
          </a>
      </span>
      
    </p>
</div>

<!-- 头部结束 -->



<!-- 分类组件，放置于文章页面的顶部，提供上(或下)一篇导航按键。 -->
<div class="asset-nav">
    <div class="entry-categories">
      <p>主题：
        <span> 
            <a href="/tags/PXT/">
              PXT
            </a>
        </span>
      </p>
    </div>
    <div class="entry-location-mobile">
        <span>
            
            <a href="/2018/05/26/online-pxt-1/">
            &#8676;
            </a>
        </span>
        <span>
            
            <a href="/2018/05/26/online-pxt-3/">
              &#8677;
            </a>
        </span>
    </div>
    <div class="entry-location">
        <P>上一篇：
                <a href="/2018/05/26/online-pxt-1/">
                    Features of the JavaScript Editor
                </a>
        </P>
        <P>下一篇：

                <a href="/2018/05/26/online-pxt-3/">
                    Async and threads
                </a>
        </P>
    </div>
</div>

<div class="post">
<div class="title-post">
<h1>Static TypeScript</h1>
<div class="post-meta">
  <p>作者： Lian</p>
  <p>日期：
    2018年05月26日 08:05
  </p>
</div>
</div>



  
  <div class="page">
      <h1 id="MakeCode-Language-Static-TypeScript"><a href="#MakeCode-Language-Static-TypeScript" class="headerlink" title="MakeCode Language: Static TypeScript"></a>MakeCode Language: Static TypeScript</h1><p>PXT programs are written in a subset of <a href="https://www.typescriptlang.org" target="_blank" rel="external">TypeScript</a><br>called Static TypeScript.  Currently, we are using TypeScript version 2.6.1.<br>TypeScript itself is a superset of JavaScript, and many PXT programs,<br>especially at the beginner’s level, are also just plain JavaScript.</p>
<p>PXT is meant for teaching programming first, and JavaScript second. For this<br>reason, we have stayed away from concepts that are specific to JavaScript (for<br>example, prototype inheritance), and instead focused on ones common to most<br>modern programming languages (for example, loops, lexically scoped variables,<br>functions, lambdas, classes).</p>
<h2 id="Supported-language-features"><a href="#Supported-language-features" class="headerlink" title="Supported language features"></a>Supported language features</h2><ul>
<li>variable declarations with <code>let</code>, <code>const</code></li>
<li>functions with lexical scoping and recursion</li>
<li>top-level code in the file; hello world really is <code>console.log(&quot;Hello world&quot;)</code></li>
<li><code>if ... else if ... else</code> statements</li>
<li><code>while</code> and <code>do ... while</code> loops</li>
<li><code>for(;;)</code> loops</li>
<li><code>for ... of</code> statements (see below about <code>for ... in</code>)</li>
<li><code>break/continue</code>; also with labeled loops</li>
<li><code>switch</code> statement (on numbers, strings, and arbitrary types - the last one isn’t very useful)</li>
<li><code>debugger</code> statement for breakpoints</li>
<li>conditional operator <code>? :</code>; lazy boolean operators</li>
<li>namespaces (a form of modules) </li>
<li>all arithmetic operators (including bitwise operators); note that in microcontroller targets<br>all arithmetic is performed on integers, also when simulating in the browser</li>
<li>strings (with a few common methods)</li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals" target="_blank" rel="external">string templates</a> (<code>`x is ${x}` </code>)</li>
<li>arrow functions <code>() =&gt; ...</code></li>
<li>passing functions (with up to 3 arguments) as values</li>
<li>classes with static and instance fields, methods and constructors; <code>new</code> keyword</li>
<li>array literals <code>[1, 2, 3]</code></li>
<li>enumerations (<code>enum</code>)</li>
<li>asynchronous functions that look <a href="/async">synchronous to the user</a></li>
<li>method-like properties (get/set accessors)</li>
<li>basic generic classes, methods, and functions</li>
<li>class inheritance</li>
<li>classes implementing interfaces (explicitly and implicitly)</li>
<li>object literals <code>{ foo: 1, bar: &quot;two&quot; }</code></li>
</ul>
<h2 id="Unsupported-language-features"><a href="#Unsupported-language-features" class="headerlink" title="Unsupported language features"></a>Unsupported language features</h2><p>Static TypeScript has a more restrictive type checker than TypeScript. In particular, it does not support:</p>
<ul>
<li>explicit or implicit use of the <code>any</code> type</li>
<li><code>union</code> or <code>intersection</code> types</li>
<li><code>interface</code> with same name as a <code>class</code></li>
<li>casts of a non-<code>class</code> type to a <code>class</code></li>
<li>downcasts of a superclass to a subclass</li>
<li>extending a <code>class</code> by an <code>interface</code></li>
<li>function parameter bi-variance (parameter subtyping is contra-variant)</li>
<li>inheriting from a built-in type</li>
<li>using a built-in or generic function as a value</li>
<li><code>this</code> used outside of a method</li>
<li>function overloading</li>
</ul>
<p>Static TypeScript enforces <em>nominal typing</em> of classes, rather than the <em>structural typing</em> of TypeScript.</p>
<p>We generally stay away from the more dynamic parts of JavaScript.  Things you may miss and we may implement:</p>
<ul>
<li>object destructuring with initializers</li>
<li>shorthand properties</li>
<li>exceptions (<code>throw</code>, <code>try ... catch</code>, <code>try ... finally</code>)</li>
<li>using generic functions as values and nested generic functions</li>
<li>class inheritance for generic classes and methods</li>
<li>initializers for class fields</li>
<li><code>public</code>/<code>private</code> annotations on constructor arguments (syntactic sugar to make them into fields)</li>
<li>binding with arrays or objects: <code>let [a, b] = ...; let { x, y } = ...</code></li>
<li><code>delete</code> statement (on object literals)</li>
<li>spread and reset operators (statically typed)</li>
<li>support of <code>enums</code> as run-time arrays</li>
<li>lambda functions with more than three arguments</li>
<li><code>new</code> on non-class types</li>
<li><code>typeof</code> expression</li>
</ul>
<p>Things that we are not very likely to implement due to the scope of the project<br>or other constraints (note that if you don’t know what a given feature is, you’re<br>unlikely to miss it):</p>
<ul>
<li>file-based modules (<code>import * from ...</code>, <code>module.exports</code> etc); we do support namespaces</li>
<li><code>yield</code> expression and <code>function*</code></li>
<li><code>await</code> expression and <code>async function</code></li>
<li><code>typeof</code> expression</li>
<li>tagged templates <code>tag `text ${expression} more text` </code>; regular templates are supported</li>
<li><code>with</code> statement</li>
<li><code>eval</code></li>
<li><code>for ... in</code> statements (<code>for ... of</code> is supported)</li>
<li>prototype-based inheritance; <code>this</code> pointer outside classes</li>
<li><code>arguments</code> keyword; <code>.apply</code> method</li>
<li>JSX (HTML fragments as part of JavaScript)</li>
</ul>
<p>For JS-only targets we may implement the following:</p>
<ul>
<li>regular expressions</li>
</ul>
<p>Note, that you can use all of these while implementing your runtime environment<br>(simulator), they just cannot be used in user’s programs.</p>
<h2 id="Semantic-differences-against-JavaScript"><a href="#Semantic-differences-against-JavaScript" class="headerlink" title="Semantic differences against JavaScript"></a>Semantic differences against JavaScript</h2><p>As such, it isn’t really feasible to run a full JavaScript virtual machine<br>in 3k of RAM, and thus PXT programs are statically compiled to native code to run efficiently.<br>There are two compilation strategies available - the legacy strategy used by the current<br>micro:bit target, and a tagged strategy used by the upcoming SAMD21 targets, as well as all<br>the other targets going forward (possibly including new version of the micro:bit target).</p>
<p>In the <strong>legacy strategy</strong>, there are some semantic differences with JavaScript,<br>particularly:</p>
<ul>
<li>numbers are 32 bit signed integers with wrap-around semantics;<br>in JavaScript they are 64 bit floating points</li>
<li>JavaScript doesn’t have types, and therefore every value can be <code>undefined</code> or <code>null</code><br>(which are two different values, distinct from <code>0</code> or <code>false</code>);<br>in PXT <code>0</code>, <code>false</code>, <code>null</code>, and <code>undefined</code> all have the same underlying<br>representation (32 zero bits) and thus will test as equal</li>
</ul>
<h2 id="Execution-environments"><a href="#Execution-environments" class="headerlink" title="Execution environments"></a>Execution environments</h2><p>PXT programs are executed in at least three different environments:</p>
<ul>
<li>microcontrollers, with native code compilation (ARM)</li>
<li>browsers</li>
<li>server-side JavaScript engines (node.js, etc)</li>
</ul>
<p>We refer to the browser execution environment as the “simulator” (of the<br>microcontroller), even though for some targets it’s the only environment.</p>
<p>The node.js execution is currently only used for automated testing, but one<br>can easily imagine a programming experience for scripts running on headless<br>devices, either locally or in the cloud.</p>
<p>In case of microcontrollers, PXT programs are<br><a href="https://www.touchdevelop.com/docs/touch-develop-in-208-bits" target="_blank" rel="external">compiled in the browser</a><br>to ARM Thumb assembly, and then to machine code, resulting in a file<br>which is then deployed to the microcontroller,<br>usually <a href="https://makecode.com/blog/one-chip-to-flash-them-all" target="_blank" rel="external">via USB mass-storage interface</a>.</p>
<p>For browsers and node.js, PXT programs are compiled to<br><a href="https://en.wikipedia.org/wiki/Continuation-passing_style" target="_blank" rel="external">continuation-passing style</a><br>JavaScript. This utilizes the TypeScript abstract syntax tree as input, but<br>does not use TypeScript JavaScript emitter.<br>On the plus side, this allows for <a href="/async">handling of async calls</a>, even if the browser<br>doesn’t support <code>yield</code> statement, as well as cross-browser and remote<br>debugging. On the other hand, the generated code is not really human readable.</p>
<p>In the <a href="/js/values">tagged strategy</a>, numbers are either tagged 31-bit signed<br>integers, or if they do not fit boxed doubles. Special constants like <code>false</code>, <code>null</code> and<br><code>undefined</code> are given special values and can be distinguished.<br>We’re aiming at full JavaScript compatibility here.</p>
<h2 id="Static-compilation-vs-a-dynamic-VM"><a href="#Static-compilation-vs-a-dynamic-VM" class="headerlink" title="Static compilation vs a dynamic VM"></a>Static compilation vs a dynamic VM</h2><p>PXT programs are compiled to native code. The native targets include ARM Thumb,<br>and an unfinished AVR port. The information below concerns the tagged compilation<br>strategy.</p>
<p>Compared to a typical dynamic JavaScript engine, PXT compiles code statically,<br>giving rise to significant time and space performance improvements:</p>
<ul>
<li>user programs are compiled directly to machine code, and are<br>never in any byte-code form that needs to be interpreted; this results in<br>much faster execution than a typical JS interpreter</li>
<li>there is no RAM overhead for user-code - all code sits in flash; in a dynamic VM<br>there are usually some data-structures representing code</li>
<li>due to lack of boxing for small integers and static class layout the memory consumption for objects<br>is around half the one you get in a dynamic VM (not counting<br>the user-code structures mentioned above)</li>
<li>while there is some runtime support code in PXT, it’s typically around 100KB smaller than<br>a dynamic VM, bringing down flash consumption and leaving more space for user code</li>
</ul>
<p>The execution time, RAM and flash consumption of PXT code is as a rule of thumb 2x of<br>compiled C code, making it competitive to write drivers and other user-space libraries.</p>
<p>Interfacing C++ from PXT is easier than interfacing typical dynamic VMs,<br>in particular for simple functions with numbers on input and output - there is<br>no need for unboxing, checking types, or memory management.</p>
<p>The main disadvantage of using static compilation is lack of dynamic features<br>in the language (think <code>eval</code>), as explained above.</p>
<p>While it is possible to run a dynamic VM even on an nRF51-class device<br>(256KB of flash, 16KB of RAM), it leaves little space for innovative features<br>on the software side, or more complex user programs and user-space (not C++) drivers.</p>
<h2 id="Smaller-int-types"><a href="#Smaller-int-types" class="headerlink" title="Smaller int types"></a>Smaller int types</h2><p>As noted above, when performing computations numbers are treated as doubles.<br>However, when you store numbers in global variables or (soon) record fields you<br>can choose to use a smaller int type to save memory. Microcontrollers typically have very<br>little memory left, so these few bytes saved here and there (especially in commonly<br>used packages) do add up.</p>
<p>The supported types are:</p>
<ul>
<li><code>uint8</code> with range <code>0</code> to <code>255</code></li>
<li><code>uint16</code> with range <code>0</code> to <code>65536</code></li>
<li><code>int8</code> with range <code>-128</code> to <code>127</code></li>
<li><code>int16</code> with range <code>-32768</code> to <code>32767</code></li>
<li><code>int32</code> with range <code>-2147483648</code> to <code>2147483647</code></li>
<li><code>uint32</code> with range <code>0</code> to <code>4294967295</code></li>
</ul>
<p>If you attempt to store a number exceeding the range of the small int type, only<br>the lowest 8 or 16 bits will be stored. There is no clamping nor overflow exceptions.</p>
<p>If you just use <code>number</code> type (or specify no type at all) in tagged strategy,<br>then if the number fits in signed 31 bits, 4 bytes of memory will be used.<br>Otherwise, the 4 bytes will point to a heap-allocated double (all together,<br>with memory allocator overhead, around 20 bytes).</p>
<p>In legacy strategy, <code>number</code> is equivalent to <code>int32</code>, and there is no <code>uint32</code>.</p>
<h3 id="Limitations"><a href="#Limitations" class="headerlink" title="Limitations"></a>Limitations</h3><ul>
<li>arrays of int types are currently not supported; you can use a <code>Buffer</code> instead</li>
<li>locals and parameters of int types are not supported</li>
</ul>

  </div>
</div>


<p class="nav-foot">
  <span class="left"><a href="/2018/05/26/online-pxt-1/">« Features o...</a></span>
  <span class="right"><a href="/2018/05/26/online-pxt-3/">Async and ... »</a></span>
</p>

<!-- 文档信息 -->
<div class="post-foot">
  <h3>文档信息</h3>
  <ul>
    <li>版权声明：自由转载-非商用-非衍生-保持署名（
      <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>）
    </li>
    <li>作者：<a href="/">Lian</a></li>
    <li>日期：2018年05月26日 08:05</li>
    <li>邮箱：lian1925@126.com</li>
  </ul>
</div>
      




<div class="content-comment">
  <h2>留言</h2>
  
  
		
</div>

<!-- 评论输入组件，填写数据：留言，称呼，电子邮件 -->

<div class="form-comment">
  <h2>
		我要发表看法
	</h2>

	<form method="post" 
	target="targetIfr"
	action="">
	 <!-- 留言正文 -->
	 
		
<p>
	<label for="comment-content">
		您的留言:
	</label>
</p>

<p>
	<textarea 
	id="comment-content" 
	name="content" 
	rows="10" cols="50">
	</textarea>
</p>

		<!-- 姓名 -->
	 
		
<p>
	<label for="comment-author">
		您的大名:
	</label>
</p>

<p>
	<input 
	id="comment-author" 
	name="author" 
	size="30" 
	value=""
	pattern="^.{2,150}$"
	required
	>
	<span class="hint">
			 «-必填
	</span
</p>


		<!-- 微信 -->
	 
		
<p>
	<label for="comment-wechat">
		您的微信:
	</label>
</p>

<p>
	<input 
	id="comment-wechat" 
	name="wechat" 
	size="30" 
	value=""
	pattern="^[a-zA-Zd_]{5,}$"
	
	>
	<span class="hint">
			 «-选填，不公开
	</span
</p>


		<!-- 电子邮箱 -->
		
		
<p>
	<label for="comment-email">
		电子邮箱：
	</label>
</p>

<p>
	<input 
	id="comment-email" 
	name="email" 
	size="30" 
	value=""
	pattern="^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(.[a-zA-Z0-9_-]+)+$"
	
	>
	<span class="hint">
			 «-选填，不公开
	</span
</p>


		
		<p>

		
<div class="button">
    <input 
    class="submit-button" 
    onclick="doButton('addComment')"
    value="发表">
    <span class="hint"> «- 点击按钮</span>
</div>
		</p>
	</form>
	<iframe name="targetIfr" style="display:none"></iframe> 
</div>


<!-- data:{
	name:'',
	type:'passwor',
	label:'您的大名',
	hint:'',
	pattern:'[A-z]{3}',
	required:"required"
} -->


<p id="info-meta" style="display:none;">
  online-pxt-2
</p>


<p id="info-url" style="display:none;">
  
</p>

<div class="footer">
  Copyright @ <a href="/">lian</a> | 2009-2018
</div>

</div>

<script src="/js/jquery.js"></script>
<script src="/js/APlayer.min.js"></script>
<script src="/js/post.js"></script>

</body>

</html>

