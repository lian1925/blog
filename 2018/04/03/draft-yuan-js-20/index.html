
<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="icon" type="image/png" href="/img/sand2.png">
  <link rel="shortcut icon" type="image/x-icon" href="/img/sand2.png">
  <meta property="og:image" content="https://assets-cdn.github.com/images/modules/open_graph/github-octocat.png">
  
  <link rel="stylesheet" href="/css/style.css?v=1.3"> 
  <link href="//vjs.zencdn.net/6.7/video-js.min.css" rel="stylesheet">
  <script src="//vjs.zencdn.net/6.7/video.min.js"></script>
  
  <title>Source Map | 小沙丘的网络漫游记</title>
 
<link rel="stylesheet" href="/css/prism-ghcolors.css" type="text/css"></head>
<body>
  
  <script>
      if (/mobile/i.test(navigator.userAgent) || /android/i.test(navigator.userAgent)){
        document.body.classList.add('mobile');            
      } else{
        document.body.classList.add('pc');
        document.getElementsByTagName("html")[0].style.fontSize="62.5%";
      }
      var u = navigator.userAgent;
var isAndroid = u.indexOf('Android') > -1 || u.indexOf('Adr') > -1; //android终端
var isiOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端
if(isiOS){
  document.body.classList.add('ios');
  document.getElementsByTagName("html")[0].style.fontSize="65%";
           
}
    </script>

  <div class="container">
<!-- 用于文章页面的顶部，提供返回主页和主题页的按键 -->
<!-- 头部开始 -->

<div id="header">
    <p>小沙丘的网络漫游记
      <span> » 
        <a href="/home/">首页</a>
      </span>
      
      <span> » 
          <a href="/tags/前端/">
            前端
          </a>
      </span>
      
    </p>
</div>

<!-- 头部结束 -->



<!-- 分类组件，放置于文章页面的顶部，提供上(或下)一篇导航按键。 -->
<div class="asset-nav">
    <div class="entry-categories">
      <p>主题：
        <span> 
            <a href="/tags/前端/">
              前端
            </a>
        </span>
      </p>
    </div>
    <div class="entry-location-mobile">
        <span>
            
            <a href="/2018/04/03/draft-yuan-js-19/">
            &#8676;
            </a>
        </span>
        <span>
            
            <a href="/2018/04/03/draft-yuan-js-21/">
              &#8677;
            </a>
        </span>
    </div>
    <div class="entry-location">
        <P>上一篇：
                <a href="/2018/04/03/draft-yuan-js-19/">
                    严格模式
                </a>
        </P>
        <P>下一篇：

                <a href="/2018/04/03/draft-yuan-js-21/">
                    有限状态机
                </a>
        </P>
    </div>
</div>

<div class="post">
<div class="title-post">
<h1>Source Map</h1>
<div class="post-meta">
  <p>作者： Lian</p>
  <p>日期：
    2018年04月03日 10:04
  </p>
</div>
</div>


<div id="aplayer1" class="aplayer"></div>


  
  <div class="page">
      <p>这是2.0版之前的最后一个新版本，有很多新功能，其中一个就是支持Source Map。</p>
<p>访问 <a href="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js，打开压缩后的版本，滚动到底部，你可以看到最后一行是这样的：" target="_blank" rel="external">http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js，打开压缩后的版本，滚动到底部，你可以看到最后一行是这样的：</a></p>
<pre class=" language-js"><code class="language-js">　　<span class="token comment" spellcheck="true">//@ sourceMappingURL=jquery.min.map</span>
</code></pre>
<p>这就是Source Map。它是一个独立的map文件，与源码在同一个目录下，你可以点击进去，看看它的样子。</p>
<p>这是一个很有用的功能，本文将详细讲解这个功能。</p>
<h2 id="一、从源码转换讲起"><a href="#一、从源码转换讲起" class="headerlink" title="一、从源码转换讲起"></a>一、从源码转换讲起</h2><p>JavaScript脚本正变得越来越复杂。大部分源码（尤其是各种函数库和框架）都要经过转换，才能投入生产环境。</p>
<p>常见的源码转换，主要是以下三种情况：</p>
<p>　　（1）压缩，减小体积。比如jQuery 1.9的源码，压缩前是252KB，压缩后是32KB。</p>
<p>　　（2）多个文件合并，减少HTTP请求数。</p>
<p>　　（3）其他语言编译成JavaScript。最常见的例子就是CoffeeScript。</p>
<p>这三种情况，都使得实际运行的代码不同于开发代码，除错（debug）变得困难重重。</p>
<p>通常，JavaScript的解释器会告诉你，第几行第几列代码出错。但是，这对于转换后的代码毫无用处。举例来说，jQuery 1.9压缩后只有3行，每行3万个字符，所有内部变量都改了名字。你看着报错信息，感到毫无头绪，根本不知道它所对应的原始位置。</p>
<p>这就是Source map想要解决的问题。</p>
<h2 id="二、什么是Source-map"><a href="#二、什么是Source-map" class="headerlink" title="二、什么是Source map"></a>二、什么是Source map</h2><p>简单说，Source map就是一个信息文件，里面储存着位置信息。也就是说，转换后的代码的每一个位置，所对应的转换前的位置。</p>
<p>有了它，出错的时候，除错工具将直接显示原始代码，而不是转换后的代码。这无疑给开发者带来了很大方便。</p>
<h2 id="三、如何启用Source-map"><a href="#三、如何启用Source-map" class="headerlink" title="三、如何启用Source map"></a>三、如何启用Source map</h2><p>正如前文所提到的，只要在转换后的代码尾部，加上一行就可以了。</p>
<pre class=" language-js"><code class="language-js">　　<span class="token comment" spellcheck="true">//@ sourceMappingURL=/path/to/file.js.map</span>
</code></pre>
<p>map文件可以放在网络上，也可以放在本地文件系统。</p>
<p>四、如何生成Source map</p>
<p>最常用的方法是使用Google的Closure编译器。</p>
<p>生成命令的格式如下：</p>
<p>　　java -jar compiler.jar \<br>　　　　–js script.js \<br>　　　　–create_source_map ./script-min.js.map \<br>　　　　–source_map_format=V3 \<br>　　　　–js_output_file script-min.js</p>
<p>各个参数的意义如下：</p>
<p>　　- js： 转换前的代码文件<br>　　- create_source_map： 生成的source map文件<br>　　- source_map_format：source map的版本，目前一律采用V3。<br>　　- js_output_file： 转换后的代码文件。</p>
<p>其他的生成方法可以参考这篇文章。</p>
<h2 id="五、Source-map的格式"><a href="#五、Source-map的格式" class="headerlink" title="五、Source map的格式"></a>五、Source map的格式</h2><p>打开Source map文件，它大概是这个样子：</p>
<pre class=" language-js"><code class="language-js">　　<span class="token punctuation">{</span>
　　　　version <span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
　　　　file<span class="token punctuation">:</span> <span class="token string">"out.js"</span><span class="token punctuation">,</span>
　　　　sourceRoot <span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
　　　　sources<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"foo.js"</span><span class="token punctuation">,</span> <span class="token string">"bar.js"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
　　　　names<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"src"</span><span class="token punctuation">,</span> <span class="token string">"maps"</span><span class="token punctuation">,</span> <span class="token string">"are"</span><span class="token punctuation">,</span> <span class="token string">"fun"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
　　　　mappings<span class="token punctuation">:</span> <span class="token string">"AAgBC,SAAQ,CAAEA"</span>
　　<span class="token punctuation">}</span>
</code></pre>
<p>整个文件就是一个JavaScript对象，可以被解释器读取。它主要有以下几个属性：</p>
<p>　　- version：Source map的版本，目前为3。</p>
<p>　　- file：转换后的文件名。</p>
<p>　　- sourceRoot：转换前的文件所在的目录。如果与转换前的文件在同一目录，该项为空。</p>
<p>　　- sources：转换前的文件。该项是一个数组，表示可能存在多个文件合并。</p>
<p>　　- names：转换前的所有变量名和属性名。</p>
<p>　　- mappings：记录位置信息的字符串，下文详细介绍。</p>
<h2 id="六、mappings属性"><a href="#六、mappings属性" class="headerlink" title="六、mappings属性"></a>六、mappings属性</h2><p>下面才是真正有趣的部分：两个文件的各个位置是如何一一对应的。</p>
<p>关键就是map文件的mappings属性。这是一个很长的字符串，它分成三层。</p>
<p>　　第一层是行对应，以分号（;）表示，每个分号对应转换后源码的一行。所以，第一个分号前的内容，就对应源码的第一行，以此类推。</p>
<p>　　第二层是位置对应，以逗号（,）表示，每个逗号对应转换后源码的一个位置。所以，第一个逗号前的内容，就对应该行源码的第一个位置，以此类推。</p>
<p>　　第三层是位置转换，以VLQ编码表示，代表该位置对应的转换前的源码位置。</p>
<p>举例来说，假定mappings属性的内容如下：</p>
<p>　　mappings:”AAAAA,BBBBB;CCCCC”</p>
<p>就表示，转换后的源码分成两行，第一行有两个位置，第二行有一个位置。</p>
<h2 id="七、位置对应的原理"><a href="#七、位置对应的原理" class="headerlink" title="七、位置对应的原理"></a>七、位置对应的原理</h2><p>每个位置使用五位，表示五个字段。</p>
<p>从左边算起，</p>
<p>　　- 第一位，表示这个位置在（转换后的代码的）的第几列。</p>
<p>　　- 第二位，表示这个位置属于sources属性中的哪一个文件。</p>
<p>　　- 第三位，表示这个位置属于转换前代码的第几行。</p>
<p>　　- 第四位，表示这个位置属于转换前代码的第几列。</p>
<p>　　- 第五位，表示这个位置属于names属性中的哪一个变量。</p>
<p>有几点需要说明。首先，所有的值都是以0作为基数的。其次，第五位不是必需的，如果该位置没有对应names属性中的变量，可以省略第五位。再次，每一位都采用VLQ编码表示；由于VLQ编码是变长的，所以每一位可以由多个字符构成。</p>
<p>如果某个位置是AAAAA，由于A在VLQ编码中表示0，因此这个位置的五个位实际上都是0。它的意思是，该位置在转换后代码的第0列，对应sources属性中第0个文件，属于转换前代码的第0行第0列，对应names属性中的第0个变量。</p>

  </div>
</div>


<p class="nav-foot">
  <span class="left"><a href="/2018/04/03/draft-yuan-js-19/">« 严格模式</a></span>
  <span class="right"><a href="/2018/04/03/draft-yuan-js-16/">AMD规范 »</a></span>
</p>

<!-- 文档信息 -->
<div class="post-foot">
  <h3>文档信息</h3>
  <ul>
    <li>版权声明：自由转载-非商用-非衍生-保持署名（
      <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>）
    </li>
    <li>作者：<a href="/">Lian</a></li>
    <li>日期：2018年04月03日 10:04</li>
    <li>邮箱：lian1925@126.com</li>
  </ul>
</div>
      




<div class="content-comment">
  <h2>留言</h2>
  
  
		
</div>

<!-- 评论输入组件，填写数据：留言，称呼，电子邮件 -->

<div class="form-comment">
  <h2>
		我要发表看法
	</h2>

	<form method="post" 
	target="targetIfr"
	action="">
	 <!-- 留言正文 -->
	 
		
<p>
	<label for="comment-content">
		您的留言:
	</label>
</p>

<p>
	<textarea 
	id="comment-content" 
	name="content" 
	rows="10" cols="50">
	</textarea>
</p>

		<!-- 姓名 -->
	 
		
<p>
	<label for="comment-author">
		您的大名:
	</label>
</p>

<p>
	<input 
	id="comment-author" 
	name="author" 
	size="30" 
	value=""
	pattern="^.{2,150}$"
	required
	>
	<span class="hint">
			 «-必填
	</span
</p>


		<!-- 微信 -->
	 
		
<p>
	<label for="comment-wechat">
		您的微信:
	</label>
</p>

<p>
	<input 
	id="comment-wechat" 
	name="wechat" 
	size="30" 
	value=""
	pattern="^[a-zA-Zd_]{5,}$"
	
	>
	<span class="hint">
			 «-选填，不公开
	</span
</p>


		<!-- 电子邮箱 -->
		
		
<p>
	<label for="comment-email">
		电子邮箱：
	</label>
</p>

<p>
	<input 
	id="comment-email" 
	name="email" 
	size="30" 
	value=""
	pattern="^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(.[a-zA-Z0-9_-]+)+$"
	
	>
	<span class="hint">
			 «-选填，不公开
	</span
</p>


		
		<p>

		
<div class="button">
    <input 
    class="submit-button" 
    onclick="doButton('addComment')"
    value="发表">
    <span class="hint"> «- 点击按钮</span>
</div>
		</p>
	</form>
	<iframe name="targetIfr" style="display:none"></iframe> 
</div>


<!-- data:{
	name:'',
	type:'passwor',
	label:'您的大名',
	hint:'',
	pattern:'[A-z]{3}',
	required:"required"
} -->


<p id="info-meta" style="display:none;">
  draft-yuan-js-20
</p>


<p id="info-url" style="display:none;">
  http://www.liangyl.com/sound/excuse_me.m4a
</p>

<div class="footer">
  Copyright @ <a href="/">lian</a> | 2009-2018
</div>

</div>

<script src="/js/jquery.js"></script>
<script src="/js/APlayer.min.js"></script>
<script src="/js/post.js"></script>

</body>

</html>

